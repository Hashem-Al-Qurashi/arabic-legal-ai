#!/usr/bin/env python3
"""
Test for Unicode input validation vulnerabilities in Google OAuth
"""

import os
import sys
import requests
import json

# Set a fake but valid-looking Google Client ID to bypass the configuration check
os.environ['GOOGLE_CLIENT_ID'] = 'fake-test-client-123456789.apps.googleusercontent.com'

def test_unicode_vulnerabilities():
    base_url = "http://localhost:8000"
    
    # Unicode edge cases that might cause issues
    unicode_tests = [
        ("Unicode null byte", "test\x00token"),
        ("Unicode control chars", "test\x01\x02\x03token"),
        ("Unicode normalization", "t√©st.t√∏ken.√±ormalization"),
        ("Unicode overlong", "\xc0\x80"),  # Overlong encoding
        ("Unicode BOM", "\ufefftoken"),
        ("Unicode RTL override", "test\u202etoken"),
        ("Unicode zero width", "test\u200btoken"),
        ("Mixed scripts", "testÊ∑∑Âêàtoken"),
        ("Emoji injection", "testüíÄüî•token"),
        ("Surrogate pairs", "test\ud800\udc00token"),
    ]
    
    print("Testing Unicode vulnerabilities with fake Google Client ID...")
    print(f"GOOGLE_CLIENT_ID set to: {os.environ.get('GOOGLE_CLIENT_ID')}")
    
    for test_name, test_token in unicode_tests:
        try:
            print(f"\nüß™ Testing: {test_name}")
            print(f"   Token: {repr(test_token)}")
            
            response = requests.post(
                f"{base_url}/api/auth/google",
                json={"id_token": test_token},
                headers={"Content-Type": "application/json"},
                timeout=5
            )
            
            print(f"   Status: {response.status_code}")
            
            if response.status_code >= 500:
                print(f"   ‚ùå SERVER ERROR: {response.status_code}")
                try:
                    error_data = response.json()
                    print(f"   Error details: {error_data}")
                except:
                    print(f"   Raw response: {response.text}")
            elif response.status_code == 200:
                print(f"   ‚ö†Ô∏è  ACCEPTED MALICIOUS INPUT!")
                print(f"   Response: {response.json()}")
            else:
                print(f"   ‚úÖ Properly rejected: {response.status_code}")
                
        except requests.exceptions.Timeout:
            print(f"   ‚ùå TIMEOUT - Server may have crashed")
        except Exception as e:
            print(f"   ‚ùå EXCEPTION: {e}")

if __name__ == "__main__":
    test_unicode_vulnerabilities()