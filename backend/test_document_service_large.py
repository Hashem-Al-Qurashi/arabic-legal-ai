import asyncio
import os
from dotenv import load_dotenv
from openai import AsyncOpenAI
from app.storage.sqlite_store import SqliteVectorStore
from app.services.document_service import DocumentService

async def test_large_document():
    """Test DocumentService with actual large legal document"""
    load_dotenv()
    
    try:
        storage = SqliteVectorStore("data/vectors.db")
        await storage.initialize()
        
        ai_client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        doc_service = DocumentService(storage, ai_client)
        
        # Real large Saudi legal document content (excerpt)
        large_legal_content = """
        ุงูููุงุฆุญ ุงูุชูููุฐูุฉ ููุธุงู ุงููุฑุงูุนุงุช ุงูุดุฑุนูุฉ

        ุงูุจุงุจ ุงูุฃูู: ุงูุชุนุฑููุงุช ูุงูุฃุญูุงู ุงูุนุงูุฉ

        ุงููุงุฏุฉ ุงูุฃููู: ูููุตุฏ ุจุงููุตุทูุญุงุช ุงููุงุฑุฏุฉ ูู ูุฐู ุงููุงุฆุญุฉ ุงููุนุงูู ุงููุจููุฉ ุฃูุงู ูู ูููุง:
        1. ุงููุธุงู: ูุธุงู ุงููุฑุงูุนุงุช ุงูุดุฑุนูุฉ ุงูุตุงุฏุฑ ุจุงููุฑุณูู ุงููููู ุฑูู (ู/1) ูุชุงุฑูุฎ 22/1/1435ูู.
        2. ุงููุงุฆุญุฉ: ุงููุงุฆุญุฉ ุงูุชูููุฐูุฉ ููุธุงู ุงููุฑุงูุนุงุช ุงูุดุฑุนูุฉ.
        3. ุงููุญููุฉ: ุฃู ูุญููุฉ ูู ูุญุงูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ.
        4. ุงููุชูุงุถู: ูู ูู ุงููุฏุนู ูุงููุฏุนู ุนููู ูุณุงุฆุฑ ุงูุฎุตูู.
        5. ุงูุฏุนูู: ุงูุทูุจ ุงููุชุถูู ุฅูุฒุงู ุงูุฎุตู ุจุฃุฏุงุก ุดูุก ุฃู ุงูุงูุชูุงุน ุนูู.

        ุงููุงุฏุฉ ุงูุซุงููุฉ: ุชุทุจู ุฃุญูุงู ูุฐู ุงููุงุฆุญุฉ ุนูู ุฌููุน ุงูุฏุนุงูู ูุงูุฅุฌุฑุงุกุงุช ุงูููุตูุต ุนูููุง ูู ุงููุธุงู.

        ุงููุงุฏุฉ ุงูุซุงูุซุฉ: ูุฌุจ ุนูู ูู ูู ูุชููู ุงููุถุงุก ุฃู ูุนูู ูู ุงูุฌูุงุฒ ุงููุถุงุฆู ุงูุชููุฏ ุจุฃุญูุงู ุงููุธุงู ููุฐู ุงููุงุฆุญุฉ.

        ุงูุจุงุจ ุงูุซุงูู: ุตุญููุฉ ุงูุฏุนูู ูุฅุฌุฑุงุกุงุช ุชูุฏูููุง

        ุงููุงุฏุฉ ุงูุฑุงุจุนุฉ: ูุฌุจ ุนูู ุงููุฏุนู ุชูุฏูู ุตุญููุฉ ุงูุฏุนูู ูุดุชููุฉ ุนูู ุงูุจูุงูุงุช ุงูุชุงููุฉ:
        1. ุงุณู ุงููุญููุฉ ุงููุฑููุนุฉ ุฅูููุง ุงูุฏุนูู.
        2. ุงุณู ุงููุฏุนู ูููุจู ููููุชู ููุญู ุฅูุงูุชู.
        3. ุงุณู ุงููุฏุนู ุนููู ูููุจู ููููุชู ููุญู ุฅูุงูุชู.
        4. ุชุงุฑูุฎ ุชูุฏูู ุตุญููุฉ ุงูุฏุนูู.
        5. ููุงุฆุน ุงูุฏุนูู ูุฃุณุงููุฏูุง.
        6. ุทูุจุงุช ุงููุฏุนู.
        7. ุชูููุน ุงููุฏุนู ุฃู ููููู.

        ุงููุงุฏุฉ ุงูุฎุงูุณุฉ: ุฅุฐุง ุชุนุฏุฏ ุงููุฏุนู ุนูููู ูุฌุจ ุฐูุฑ ุงุณู ูู ูููู ูููุจู ููููุชู ููุญู ุฅูุงูุชู.

        ุงููุงุฏุฉ ุงูุณุงุฏุณุฉ: ูุฌูุฒ ูููุฏุนู ุฃู ููุฏุน ูุน ุตุญููุฉ ุงูุฏุนูู ุงููุณุชูุฏุงุช ุงููุคูุฏุฉ ูุฏุนูุงู.

        ุงูุจุงุจ ุงูุซุงูุซ: ุฅุฌุฑุงุกุงุช ุงูุชุจููุบ ูุงูุฅุนูุงู

        ุงููุงุฏุฉ ุงูุณุงุจุนุฉ: ูููู ุงูุชุจููุบ ุจุชุณููู ุตูุฑุฉ ูู ุงูุตุญููุฉ ุฃู ุงููุฑูุฉ ุงููุฑุงุฏ ุชุจููุบูุง ุฅูู ุงููุฑุงุฏ ุชุจููุบู ุดุฎุตูุงู.

        ุงููุงุฏุฉ ุงูุซุงููุฉ: ุฅุฐุง ูู ููุฌุฏ ุงููุฑุงุฏ ุชุจููุบู ูู ูุญู ุฅูุงูุชู ููุณูู ุงูุชุจููุบ ุฅูู ูู ููุฌุฏ ูู ุฃูู ุจูุชู ุงูุจุงูุบูู.

        ุงููุงุฏุฉ ุงูุชุงุณุนุฉ: ุฅุฐุง ุงูุชูุน ุงููุฑุงุฏ ุชุจููุบู ุฃู ูู ูููุจ ุนูู ุนู ุชุณูู ุงูุชุจููุบ ููุชุฑู ุงูุชุจููุบ ูู ูุญู ุฅูุงูุชู.

        ุงูุจุงุจ ุงูุฑุงุจุน: ุงูุฌูุณุงุช ูุงููุฑุงูุนุงุช

        ุงููุงุฏุฉ ุงูุนุงุดุฑุฉ: ุชููู ุงูุฌูุณุงุช ุนูููุฉ ุฅูุง ุฅุฐุง ุฑุฃุช ุงููุญููุฉ ูู ุชููุงุก ููุณูุง ุฃู ุจูุงุกู ุนูู ุทูุจ ุฃุญุฏ ุงูุฎุตูู ุฌุนููุง ุณุฑูุฉ.

        ุงููุงุฏุฉ ุงูุญุงุฏูุฉ ุนุดุฑุฉ: ูููุญููุฉ ุฃู ุชุณูุน ุงูุฏุนูู ูู ุบูุงุจ ุฃุญุฏ ุงูุฎุตูู ุฅุฐุง ูุงู ุงูุชุจููุบ ุตุญูุญุงู.

        ุงููุงุฏุฉ ุงูุซุงููุฉ ุนุดุฑุฉ: ูุฌูุฒ ููุฎุตู ุฃู ูุชุฑุงูุน ุจููุณู ุฃู ุจูุงุณุทุฉ ูููู ูุนุชูุฏ ูู ุงููุญููุฉ.

        ุงูุจุงุจ ุงูุฎุงูุณ: ุงูุฃุญูุงู ูุชูููุฐูุง

        ุงููุงุฏุฉ ุงูุซุงูุซุฉ ุนุดุฑุฉ: ุชุตุฏุฑ ุงูุฃุญูุงู ุจุงุณู ุงูููู ูุชุดุชูู ุนูู ุงูุฃุณุจุงุจ ุงูุชู ุจููุช ุนูููุง.

        ุงููุงุฏุฉ ุงูุฑุงุจุนุฉ ุนุดุฑุฉ: ูุฌุจ ุฃู ูููู ุงูุญูู ูุงุถุญุงู ูุงุจูุงู ููุชูููุฐ.

        ุงููุงุฏุฉ ุงูุฎุงูุณุฉ ุนุดุฑุฉ: ุชููุฐ ุงูุฃุญูุงู ุงูููุงุฆูุฉ ุจุนุฏ ุงููุถุงุก ูุฏุฉ ุงูุงุนุชุฑุงุถ ุฃู ุจุนุฏ ุงููุตู ูู ุงูุงุนุชุฑุงุถ.

        ุงูุจุงุจ ุงูุณุงุฏุณ: ุงูุทุนู ูู ุงูุฃุญูุงู

        ุงููุงุฏุฉ ุงูุณุงุฏุณุฉ ุนุดุฑุฉ: ูุฌูุฒ ุงูุทุนู ูู ุงูุฃุญูุงู ูููุงู ููุฃุญูุงู ุงูููุตูุต ุนูููุง ูู ุงููุธุงู.

        ุงููุงุฏุฉ ุงูุณุงุจุนุฉ ุนุดุฑุฉ: ูุฌุจ ุชูุฏูู ุงูุทุนู ุฎูุงู ุงููุฏุฉ ุงููุญุฏุฏุฉ ูู ุงููุธุงู.

        ุงููุงุฏุฉ ุงูุซุงููุฉ ุนุดุฑุฉ: ูุชุฑุชุจ ุนูู ุชูุฏูู ุงูุทุนู ููู ุชูููุฐ ุงูุญูู ุฅูุง ูู ุงูุญุงูุงุช ุงููุณุชุซูุงุฉ.
        """ * 15  # Multiply to make it realistically large (around 15K+ tokens)
        
        large_doc = [{
            "title": "ุงูููุงุฆุญ ุงูุชูููุฐูุฉ ููุธุงู ุงููุฑุงูุนุงุช ุงูุดุฑุนูุฉ",
            "content": large_legal_content,
            "metadata": {
                "source": "ministry_of_justice",
                "document_type": "executive_regulations",
                "legal_system": "sharia_procedures"
            }
        }]
        
        print(f"๐ Document: {large_doc[0]['title']}")
        print(f"๐ Content length: {len(large_doc[0]['content']):,} chars")
        print(f"๐ข Estimated tokens: {len(large_doc[0]['content']) // 2:,}")
        print()
        
        print("๐งช Testing Large Document Processing...")
        result = await doc_service.add_documents_batch(large_doc)
        print(f"โ Result: {result}")
        
        # Check what was stored
        print("\n๐ Storage Status:")
        health = await doc_service.get_storage_health()
        print(f"๐ฅ Storage Health: {health}")
        
    except Exception as e:
        print(f"โ Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(test_large_document())
